## 1.1å½“ææ„å‡½æ•°é‡åˆ°å¤šçº¿ç¨‹

### 1.1.2 MutexLockä¸MutexLockGuard

>ä»£ç è§&2.4
>MutexLockå°è£…ä¸´ç•ŒåŒºï¼ˆcritical sectionï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„èµ„æºç±»ï¼Œç”¨RAII(RAIIå…¨ç§°æ˜¯â€œResource Acquisition is Initializationâ€ï¼Œç›´è¯‘è¿‡æ¥æ˜¯â€œèµ„æºè·å–å³åˆå§‹åŒ–â€,ä¹Ÿå°±æ˜¯è¯´åœ¨æ„é€ å‡½æ•°ä¸­ç”³è¯·åˆ†é…èµ„æºï¼Œåœ¨ææ„å‡½æ•°ä¸­é‡Šæ”¾èµ„æº)æ‰‹æ³•å°è£…äº’æ–¥å™¨çš„åˆ›å»ºä¸é”€æ¯ã€‚åœ¨Linuxä¸‹æ˜¯pthread_mutex_tï¼Œé»˜è®¤æ˜¯ä¸å¯é‡å…¥çš„ï¼ˆ&2.1.1ï¼‰ã€‚MutexLockä¸€èˆ¬æ˜¯åˆ«çš„classçš„æ•°æ®æˆå‘˜ã€‚   

[RAIIå‚è€ƒé“¾æ¥](https://www.cnblogs.com/jiangbin/p/6986511.html)
>RAII ï¼šé€šå¸¸çš„åšæ³•æ˜¯owneræŒæœ‰æŒ‡å‘childçš„shared_ptr,childæŒæœ‰æŒ‡å‘ownerçš„weak_ptrã€‚

>MutexLockGuardå°è£…ä¸´ç•ŒåŒºçš„è¿›å…¥å’Œé€€å‡ºï¼Œå³åŠ é”å’Œè§£é”ã€‚MutexLockGuardä¸€èˆ¬æ˜¯ä¸ªæ ˆä¸Šçš„å¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨åŸŸåˆšå¥½ç­‰äºä¸´ç•ŒåŒºåŸŸã€‚

>è¿™ä¸¤ä¸ªclasséƒ½ä¸å…è®¸æ‹·è´æ„é€ å’Œèµ‹å€¼ï¼Œä½¿ç”¨åŸåˆ™è§&2.1ã€‚

### 1.1.3 ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„Counterç¤ºä¾‹

å¯¹è±¡æ„é€ è¦åšåˆ°çº¿ç¨‹å®‰å…¨ï¼Œå”¯ä¸€çš„è¦æ±‚æ˜¯åœ¨æ„é€ æœŸé—´ä¸è¦æ³„éœ²thisæŒ‡é’ˆï¼Œå³ï¼š
 1.ä¸è¦åœ¨æ„é€ å‡½æ•°ä¸­æ³¨å†Œä»»ä½•å›è°ƒã€‚

åœ¨æ„é€ å‡½æ•°ä¸­æ³¨å†Œå›è°ƒå‡½æ•°ï¼ˆå¦‚äº‹ä»¶ç›‘å¬å™¨ã€ä¿¡å·æ§½ç­‰ï¼‰æ—¶ï¼Œé€šå¸¸ä¼šå°† `this` æŒ‡é’ˆä¼ é€’ç»™å›è°ƒæœºåˆ¶ã€‚å¦‚æœè¿™äº›å›è°ƒåœ¨å¯¹è±¡å°šæœªå®Œå…¨æ„é€ æ—¶è¢«è§¦å‘ï¼Œå¯èƒ½ä¼šè®¿é—®æœªåˆå§‹åŒ–çš„æˆå‘˜ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒæˆ–è¡Œä¸ºå¼‚å¸¸ã€‚

```c++
class MyClass {
public:
    MyClass(EventDispatcher& dispatcher) {
        dispatcher.registerCallback([this]() { onEvent(); }); // âŒ ä¸å®‰å…¨
    }

    void onEvent() {
        // å¯èƒ½è®¿é—®æœªåˆå§‹åŒ–çš„æˆå‘˜
    }
};
```

2.ä¸è¦åœ¨æ„é€ å‡½æ•°ä¸­æŠŠthisä¼ ç»™è·¨çº¿ç¨‹çš„å¯¹è±¡ã€‚

åœ¨æ„é€ å‡½æ•°ä¸­å°† `this` æŒ‡é’ˆä¼ é€’ç»™å¯èƒ½åœ¨å…¶ä»–çº¿ç¨‹ä¸­ä½¿ç”¨çš„å¯¹è±¡ï¼ˆå¦‚å¯åŠ¨æ–°çº¿ç¨‹ã€ä»»åŠ¡é˜Ÿåˆ—ç­‰ï¼‰æ˜¯å±é™©çš„ã€‚å› ä¸ºæ–°çº¿ç¨‹å¯èƒ½åœ¨å¯¹è±¡å°šæœªå®Œå…¨æ„é€ æ—¶å¼€å§‹æ‰§è¡Œï¼Œè®¿é—®æœªåˆå§‹åŒ–çš„æˆå‘˜ï¼Œå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚

3.å³ä¾¿åœ¨æ„é€ å‡½æ•°çš„æœ€åä¸€è¡Œä¹Ÿä¸è¡Œã€‚

å³ä½¿åœ¨æ„é€ å‡½æ•°çš„æœ€åä¸€è¡Œå°† `this` æŒ‡é’ˆæ³„éœ²ï¼Œä¹Ÿä¸èƒ½ä¿è¯å®‰å…¨ã€‚C++ çš„å†…å­˜æ¨¡å‹å¹¶ä¸ä¿è¯æ„é€ å‡½æ•°ä½“çš„æ‰§è¡Œä¸å¯¹è±¡çš„å®Œæ•´æ„é€ ä¹‹é—´çš„é¡ºåºå¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚å› æ­¤ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½åœ¨å¯¹è±¡å°šæœªå®Œå…¨æ„é€ æ—¶è®¿é—®å®ƒã€‚

[å…³é”®å­—mutable](https://blog.csdn.net/aaa123524457/article/details/80967330) [å…³é”®å­—const](https://www.cnblogs.com/kevinWu7/p/10163449.html)

## 1.4 çº¿ç¨‹å®‰å…¨çš„Oberveræœ‰å¤šéš¾

> åœ¨é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ä¸­ï¼Œå¯¹è±¡çš„å…³ç³»ä¸»è¦æœ‰ä¸‰ç§ï¼šcomposition(ç»„åˆ/å¤åˆ)ï¼Œaggregation(å…³è”/è”ç³»)ï¼Œassociation(èšåˆ)ã€‚

[å…³ç³»](https://github.com/xyz2781790037/muduo/blob/main/note/01_1.md)

associationï¼ˆå…³è”/è”ç³»ï¼‰æ˜¯ä¸€ç§å¾ˆå®½æ³›çš„å…³ç³»ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªå¯¹è±¡aç”¨åˆ°äº†å¦ä¸€ä¸ªå¯¹è±¡bï¼Œè°ƒç”¨äº†åè€…çš„æˆå‘˜å‡½æ•°ï¼Œä»ä»£ç å½¢å¼ä¸Šçœ‹ï¼ŒaæŒæœ‰bçš„æŒ‡é’ˆæˆ–å¼•ç”¨ï¼Œä½†bçš„ç”Ÿå‘½æœŸä¸ç”±aå•ç‹¬æ§åˆ¶ã€‚aggregationï¼ˆèšåˆï¼‰å…³ç³»ä»å½¢å¼ä¸Šçœ‹ä¸associationç›¸åŒï¼Œé™¤äº†aå’Œbç”±é€»è¾‘ä¸Šçš„æ•´ä½“ä¸éƒ¨åˆ†å…³ç³»ï¼Œå¦‚æœbæ˜¯åŠ¨æ€åˆ›å»ºçš„å¹¶åœ¨æ•´ä¸ªç¨‹åºç»“æŸå‰æœ‰å¯èƒ½è¢«é‡Šæ”¾ï¼Œå°±ä¼šå‡ºç°ç«æ€æ¡ä»¶ã€‚å¦‚æœ **B æ˜¯åœ¨å¤–éƒ¨åŠ¨æ€åˆ›å»ºçš„**ï¼ˆå¦‚é€šè¿‡ `new`ï¼‰ï¼Œè€Œ A åªæ˜¯â€œå¼±å¼•ç”¨â€å®ƒï¼ˆæ²¡æœ‰ç®¡ç† B çš„ç”Ÿå‘½å‘¨æœŸï¼‰ï¼Œé‚£ä¹ˆï¼š

- B å¯èƒ½åœ¨ç¨‹åºæŸä¸ªæ—¶åˆ»è¢«åˆ«çš„å¯¹è±¡é”€æ¯ï¼›
- è€Œ A å¹¶ä¸çŸ¥é“ B å·²ç»å¤±æ•ˆï¼Œè¿˜å°è¯•è®¿é—®å®ƒï¼›
- å°±ä¼šå¼•å‘**æ‚¬å‚æŒ‡é’ˆã€ç«æ€æ¡ä»¶æˆ–æœªå®šä¹‰è¡Œä¸º**ã€‚

```c++
class Observer // : boost::noncopyable
{
public:
    virtual ~Observer();
    virtual void update() = 0;
    // ...
};

class Observable // : boost::noncopyable
{
public:
    void register_(Observer *x);
    void unregister(Observer *x);
    
    void notifyObservers() 
    {
        for (Observer *x : observers_) 
        {
            x->update();    // (3)
        }
    }

private:
    std::vector<Observer *> observers_;
};
```

å½“Observableé€šçŸ¥æ¯ä¸ªObserveræ—¶ï¼Œå®ƒä»ä½•å¤„å¾—çŸ¥Observerå¯¹è±¡xè¿˜æ´»ç€ï¼Ÿä¸‹é¢è¯•è¯•åœ¨Observerçš„ææ„å‡½æ•°é‡Œè°ƒç”¨unregister()æ¥è§£æ³¨å†Œï¼š

```c++
class Observer
{
    void observe(Observable *s)
    {
        s->register_(this);
        subject_ = s;
    }
    
    virtual ~Observer() 
    {
        subject_->unregister(this);
    }
    
    Observable *subject_;
};
```

æˆ‘ä»¬è¯•ç€è®©Observerçš„ææ„å‡½æ•°å»è°ƒç”¨unregister(this)ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªrace conditionï¼š
 1.`subject_->unregister(this);`å¦‚ä½•çŸ¥é“subject_è¿˜æ´»ç€ï¼Ÿ

```c++
{
    Observable* s = new Observable;
    Observer* ob = new SomeObserver;
    ob->observe(s);
    delete s;      // Observable å…ˆè¢«é”€æ¯
    delete ob;     // Observer ææ„æ—¶è®¿é—®äº†å·²é”€æ¯çš„ s -> UB
}
```

2.å°±ç®—subject_æŒ‡å‘æŸä¸ªæ°¸ä¹…å­˜åœ¨çš„å¯¹è±¡ï¼Œè¿˜æ˜¯é™©è±¡ç¯ç”Ÿï¼š
 ï¼ˆ1ï¼‰çº¿ç¨‹Aæ‰§è¡Œåˆ°`subject_->unregister(this);`å‰ï¼Œè¿˜æ²¡æ¥å¾—åŠunregisteræœ¬å¯¹è±¡ã€‚

ï¼ˆ2ï¼‰çº¿ç¨‹Bæ‰§è¡Œåˆ°`x->update();`ï¼Œxæ­£å¥½æŒ‡å‘ï¼ˆ1ï¼‰ä¸­æ­£åœ¨ææ„çš„å¯¹è±¡ã€‚

> - `subject_` æ˜¯ä¸€ä¸ª**ä¸€ç›´æ´»ç€çš„å¯¹è±¡**ï¼ˆä¸ä¼šè¢«é”€æ¯ï¼‰ï¼›
> - `this` æ˜¯ä¸€ä¸ª `Observer` æ´¾ç”Ÿç±»å¯¹è±¡ï¼›
> - å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ A å’Œ B åŒæ—¶åœ¨æ“ä½œç›¸å…³å¯¹è±¡ã€‚
>
> å‘ç”Ÿçš„äº‹ä»¶å¦‚ä¸‹ï¼š
>
> ### ğŸ§µ çº¿ç¨‹ Aï¼š
>
> - æ­£åœ¨ææ„ `Observer` å¯¹è±¡ã€‚
> - æ‰§è¡Œåˆ° `subject_->unregister(this);` **ä¹‹å‰**ï¼Œå¯¹è±¡æ­£å¤„äº**ææ„è¿‡ç¨‹ä¸­**ã€‚
>
> ### ğŸ§µ çº¿ç¨‹ Bï¼š
>
> - æ­£åœ¨è°ƒç”¨ `subject_->notifyObservers();`ã€‚
> - éå† `observers_`ï¼Œè°ƒç”¨ `x->update();`ã€‚
> - `x == this`ï¼Œæ­£å¥½æ˜¯æ­£åœ¨è¢«ææ„çš„å¯¹è±¡ã€‚

ä½ å¯ä»¥æƒ³è±¡ `this` æ˜¯ä¸€ä¸ªäººï¼Œ`update()` æ˜¯è„‘å­é‡Œçš„â€œè®°å¿†åŠŸèƒ½â€ã€‚

> å½“çº¿ç¨‹ A å¼€å§‹â€œç«åŒ–â€è¿™ä¸ªäººï¼ˆææ„ï¼‰ï¼Œå¤´è„‘ï¼ˆæ´¾ç”Ÿç±»é€»è¾‘ï¼‰å·²ç»çƒ§æ‰ï¼›
>  è¿™æ—¶çº¿ç¨‹ B è¿˜è¯•å›¾å¯¹è¿™ä¸ªäººè¯´è¯ï¼ˆè°ƒç”¨ `update()`ï¼‰ï¼›
>  ç»“æœä»–ä¼šç–¯æ‰ï¼ˆå´©æºƒï¼‰æˆ–çå›ç­”ï¼ˆæ•°æ®é”™ä¹±ï¼‰ï¼Œå› ä¸ºä»–å·²ç»å¤±å»ä¸€åŠçš„çµé­‚ï¼ˆvtable æŸåï¼‰ï¼

å¦‚æœå¯¹è±¡è¿˜æ´»ç€ï¼Œå°±è°ƒç”¨å®ƒçš„æˆå‘˜å‡½æ•°ï¼Œå¦åˆ™å¿½ç•¥ä¹‹ã€‚å°±åƒObservable::notifyObservers()é‚£æ ·ï¼Œä½œè€…ç§°ä¹‹ä¸ºå¼±å›è°ƒã€‚è¿™ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„ï¼Œåˆ©ç”¨weak_ptrï¼Œæˆ‘ä»¬å¯ä»¥æŠŠweak_ptrç»‘åˆ°boost::functioné‡Œï¼Œè¿™æ ·å¯¹è±¡çš„ç”Ÿå‘½æœŸå°±ä¸ä¼šè¢«å»¶é•¿ï¼Œç„¶ååœ¨å›è°ƒæ—¶å…ˆå°è¯•æå‡ä¸ºshared_ptrï¼Œå¦‚æœæå‡æˆåŠŸï¼Œè¯´æ˜æ¥å—å›è°ƒçš„å¯¹è±¡è¿˜å¥åœ¨ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œå›è°ƒï¼Œå¦‚æœæå‡å¤±è´¥ï¼Œå°±ä¸æ‰§è¡Œå›è°ƒã€‚

ä½¿ç”¨è¿™ä¸€æŠ€æœ¯çš„StockFactoryå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š


```c++
class StockFactory : public boost::enable_shared_from_this<StockFactory>, boost::noncopyable
{
public:
    shared_ptr<Stock> get(const string &key) 
    {
        shared_ptr<Stock> pStock;
        MutexLockGuard lock(mutex_);
        // wkStockæ˜¯å¼•ç”¨
        weak_ptr<Stock> &wkStock = stocks_[key];
        pStock = wkStock.lock();
        if (!pStock) 
        {
            pStock.reset(new Stock(key), boost::bind(&StockFactory::weakDeleteCallback,
                                                     boost::weak_ptr<StockFactory>(shared_from_this()),
                                                     _1);
            // å¿…é¡»æŠŠshared_from_this()è½¬å‹ä¸ºweak_ptrï¼Œæ‰ä¸ä¼šå»¶é•¿ç”Ÿå‘½æœŸ
            wkStock = pStock;
        }
        return pStock;
    }

private:
    static void weakDeleteCallback(const boost::weak_ptr<StockFactory> &wkFactory, Stock *stock) 
    {
        // å°è¯•æå‡
        shared_ptr<StockFactory> factory(wkFactory.lock());
        // å¦‚æœfactoryè¿˜åœ¨ï¼Œå°±æ¸…ç†stocks_
        if (factory)
        {
            factory->removeStock(stock);
        }
        delete stock;
    }
    
    void removeStock(Stock *stock) 
    {
        if (stock)
        {
            MutexLockGuard lock(mutex_);
            stocks_.erase(stock->key());
        }
    }

private:
    mutable MutexLock mutex_;
    std::map<string, weak_ptr<Stock>> stocks_;
};
```

